{"version":3,"names":["Object","defineProperty","exports","value","default","TestEnvironment","_jsdom","data","require","_fakeTimers","_jestMock","_jestUtil","isString","JSDOMEnvironment","dom","fakeTimers","fakeTimersModern","global","errorEventListener","moduleMocker","customExportConditions","_configuredExportConditions","constructor","config","context","projectConfig","virtualConsole","VirtualConsole","sendTo","console","omitJSDOMErrors","on","error","JSDOM","testEnvironmentOptions","html","pretendToBeVisual","resources","userAgent","ResourceLoader","undefined","runScripts","url","window","Error","stackTraceLimit","installCommonGlobals","globals","Buffer","event","userErrorListenerCount","process","emit","addEventListener","originalAddListener","bind","originalRemoveListener","removeEventListener","args","apply","Array","isArray","every","ModuleMocker","LegacyFakeTimers","timerConfig","idToRef","id","refToId","ref","ModernFakeTimers","setup","teardown","dispose","close","exportConditions","getVmContext","getInternalVMContext"],"sources":["index.js"],"sourcesContent":["'use strict';\n\nObject.defineProperty(exports, '__esModule', {\n  value: true\n});\nexports.default = exports.TestEnvironment = void 0;\nfunction _jsdom() {\n  const data = require('jsdom');\n  _jsdom = function () {\n    return data;\n  };\n  return data;\n}\nfunction _fakeTimers() {\n  const data = require('@jest/fake-timers');\n  _fakeTimers = function () {\n    return data;\n  };\n  return data;\n}\nfunction _jestMock() {\n  const data = require('jest-mock');\n  _jestMock = function () {\n    return data;\n  };\n  return data;\n}\nfunction _jestUtil() {\n  const data = require('jest-util');\n  _jestUtil = function () {\n    return data;\n  };\n  return data;\n}\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n// The `Window` interface does not have an `Error.stackTraceLimit` property, but\n// `JSDOMEnvironment` assumes it is there.\nfunction isString(value) {\n  return typeof value === 'string';\n}\nclass JSDOMEnvironment {\n  dom;\n  fakeTimers;\n  fakeTimersModern;\n  global;\n  errorEventListener;\n  moduleMocker;\n  customExportConditions = ['browser'];\n  _configuredExportConditions;\n  constructor(config, context) {\n    const {projectConfig} = config;\n    const virtualConsole = new (_jsdom().VirtualConsole)();\n    virtualConsole.sendTo(context.console, {\n      omitJSDOMErrors: true\n    });\n    virtualConsole.on('jsdomError', error => {\n      context.console.error(error);\n    });\n    this.dom = new (_jsdom().JSDOM)(\n      typeof projectConfig.testEnvironmentOptions.html === 'string'\n        ? projectConfig.testEnvironmentOptions.html\n        : '<!DOCTYPE html>',\n      {\n        pretendToBeVisual: true,\n        resources:\n          typeof projectConfig.testEnvironmentOptions.userAgent === 'string'\n            ? new (_jsdom().ResourceLoader)({\n                userAgent: projectConfig.testEnvironmentOptions.userAgent\n              })\n            : undefined,\n        runScripts: 'dangerously',\n        url: 'http://localhost/',\n        virtualConsole,\n        ...projectConfig.testEnvironmentOptions\n      }\n    );\n    const global = (this.global = this.dom.window);\n    if (global == null) {\n      throw new Error('JSDOM did not return a Window object');\n    }\n\n    // @ts-expect-error - for \"universal\" code (code should use `globalThis`)\n    global.global = global;\n\n    // Node's error-message stack size is limited at 10, but it's pretty useful\n    // to see more than that when a test fails.\n    this.global.Error.stackTraceLimit = 100;\n    (0, _jestUtil().installCommonGlobals)(global, projectConfig.globals);\n\n    // TODO: remove this ASAP, but it currently causes tests to run really slow\n    global.Buffer = Buffer;\n\n    // Report uncaught errors.\n    this.errorEventListener = event => {\n      if (userErrorListenerCount === 0 && event.error != null) {\n        process.emit('uncaughtException', event.error);\n      }\n    };\n    global.addEventListener('error', this.errorEventListener);\n\n    // However, don't report them as uncaught if the user listens to 'error' event.\n    // In that case, we assume the might have custom error handling logic.\n    const originalAddListener = global.addEventListener.bind(global);\n    const originalRemoveListener = global.removeEventListener.bind(global);\n    let userErrorListenerCount = 0;\n    global.addEventListener = function (...args) {\n      if (args[0] === 'error') {\n        userErrorListenerCount++;\n      }\n      return originalAddListener.apply(this, args);\n    };\n    global.removeEventListener = function (...args) {\n      if (args[0] === 'error') {\n        userErrorListenerCount--;\n      }\n      return originalRemoveListener.apply(this, args);\n    };\n    if ('customExportConditions' in projectConfig.testEnvironmentOptions) {\n      const {customExportConditions} = projectConfig.testEnvironmentOptions;\n      if (\n        Array.isArray(customExportConditions) &&\n        customExportConditions.every(isString)\n      ) {\n        this._configuredExportConditions = customExportConditions;\n      } else {\n        throw new Error(\n          'Custom export conditions specified but they are not an array of strings'\n        );\n      }\n    }\n    this.moduleMocker = new (_jestMock().ModuleMocker)(global);\n    this.fakeTimers = new (_fakeTimers().LegacyFakeTimers)({\n      config: projectConfig,\n      global: global,\n      moduleMocker: this.moduleMocker,\n      timerConfig: {\n        idToRef: id => id,\n        refToId: ref => ref\n      }\n    });\n    this.fakeTimersModern = new (_fakeTimers().ModernFakeTimers)({\n      config: projectConfig,\n      global: global\n    });\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\n  async setup() {}\n  async teardown() {\n    if (this.fakeTimers) {\n      this.fakeTimers.dispose();\n    }\n    if (this.fakeTimersModern) {\n      this.fakeTimersModern.dispose();\n    }\n    if (this.global != null) {\n      if (this.errorEventListener) {\n        this.global.removeEventListener('error', this.errorEventListener);\n      }\n      this.global.close();\n    }\n    this.errorEventListener = null;\n    // @ts-expect-error: this.global not allowed to be `null`\n    this.global = null;\n    this.dom = null;\n    this.fakeTimers = null;\n    this.fakeTimersModern = null;\n  }\n  exportConditions() {\n    return this._configuredExportConditions ?? this.customExportConditions;\n  }\n  getVmContext() {\n    if (this.dom) {\n      return this.dom.getInternalVMContext();\n    }\n    return null;\n  }\n}\nexports.default = JSDOMEnvironment;\nconst TestEnvironment = JSDOMEnvironment;\nexports.TestEnvironment = TestEnvironment;\n"],"mappings":"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"}